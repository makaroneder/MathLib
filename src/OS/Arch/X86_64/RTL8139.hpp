#ifdef __x86_64__
#ifndef RTL8139_H
#define RTL8139_H
#include "PCI/PCIHeader.hpp"
#include "Interrupts/InterruptDevice.hpp"
#include <MAC.hpp>

struct RTL8139 : InterruptDevice {
    enum class IOOffset : uint8_t {
        ID0 = 0x00,
        ID1,
        ID2,
        ID3,
        ID4,
        ID5,
        Reserved1,
        Reserved2,
        Multicast0,
        Multicast1,
        Multicast2,
        Multicast3,
        Multicast4,
        Multicast5,
        Multicast6,
        Multicast7,
        TransmitStatusOfDescriptor00,
        TransmitStatusOfDescriptor01,
        TransmitStatusOfDescriptor02,
        TransmitStatusOfDescriptor03,
        TransmitStatusOfDescriptor10,
        TransmitStatusOfDescriptor11,
        TransmitStatusOfDescriptor12,
        TransmitStatusOfDescriptor13,
        TransmitStatusOfDescriptor20,
        TransmitStatusOfDescriptor21,
        TransmitStatusOfDescriptor22,
        TransmitStatusOfDescriptor23,
        TransmitStatusOfDescriptor30,
        TransmitStatusOfDescriptor31,
        TransmitStatusOfDescriptor32,
        TransmitStatusOfDescriptor33,
        TransmitStartOfDescriptor00,
        TransmitStartOfDescriptor01,
        TransmitStartOfDescriptor02,
        TransmitStartOfDescriptor03,
        TransmitStartOfDescriptor10,
        TransmitStartOfDescriptor11,
        TransmitStartOfDescriptor12,
        TransmitStartOfDescriptor13,
        TransmitStartOfDescriptor20,
        TransmitStartOfDescriptor21,
        TransmitStartOfDescriptor22,
        TransmitStartOfDescriptor23,
        TransmitStartOfDescriptor30,
        TransmitStartOfDescriptor31,
        TransmitStartOfDescriptor32,
        TransmitStartOfDescriptor33,
        ReceiveBufferStart0,
        ReceiveBufferStart1,
        ReceiveBufferStart2,
        ReceiveBufferStart3,
        EarlyReceiveByteCount0,
        EarlyReceiveByteCount1,
        EarlyReceiveStatus,
        Command,
        PacketReadAddress0,
        PacketReadAddress1,
        BufferAddress0,
        BufferAddress1,
        InterruptMask0,
        InterruptMask1,
        InterruptStatus0,
        InterruptStatus1,
        TransmitConfiguration0,
        TransmitConfiguration1,
        TransmitConfiguration2,
        TransmitConfiguration3,
        ReceiveConfiguration0,
        ReceiveConfiguration1,
        ReceiveConfiguration2,
        ReceiveConfiguration3,
        TimerCount0,
        TimerCount1,
        TimerCount2,
        TimerCount3,
        MissedPacketCounter0,
        MissedPacketCounter1,
        MissedPacketCounter2,
        MissedPacketCounter3,
        Command93c46,
        Configuration0,
        Configuration1,
        Reserved3,
        TimerInterrupt0,
        TimerInterrupt1,
        TimerInterrupt2,
        TimerInterrupt3,
        MediaStatus,
        Configuration3,
        Configuration4,
        Reserved4,
        MultipleInterruptSelect0,
        MultipleInterruptSelect1,
        PCIRevisionID,
        Reserved5,
        TransmitStatusOfAllDescriptors0,
        TransmitStatusOfAllDescriptors1,
        BasicModeControl0,
        BasicModeControl1,
        BasicModeStatus0,
        BasicModeStatus1,
        AutoNegotiationAdvertisement0,
        AutoNegotiationAdvertisement1,
        AutoNegotiationLinkPartner0,
        AutoNegotiationLinkPartner1,
        AutoNegotiationExpansion0,
        AutoNegotiationExpansion1,
        DisconnectCounter0,
        DisconnectCounter1,
        FalseCarrierSenseCounter0,
        FalseCarrierSenseCounter1,
        NWayTest0,
        NWayTest1,
        RXErrorCounter0,
        RXErrorCounter1,
        CSConfiguration0,
        CSConfiguration1,
        Reserved6,
        Reserved7,
        PHY0,
        PHY1,
        PHY2,
        PHY3,
        Twister0,
        Twister1,
        Twister2,
        Twister3,
        PHY4,
        Reserved8,
        LowTXAddress0,
        LowTXAddress1,
        PowerManagmentCRC0,
        PowerManagmentCRC1,
        PowerManagmentCRC2,
        PowerManagmentCRC3,
        PowerManagmentCRC4,
        PowerManagmentCRC5,
        PowerManagmentCRC6,
        PowerManagmentCRC7,
        PowerManagmentWakeup00,
        PowerManagmentWakeup01,
        PowerManagmentWakeup02,
        PowerManagmentWakeup03,
        PowerManagmentWakeup04,
        PowerManagmentWakeup05,
        PowerManagmentWakeup06,
        PowerManagmentWakeup07,
        PowerManagmentWakeup10,
        PowerManagmentWakeup11,
        PowerManagmentWakeup12,
        PowerManagmentWakeup13,
        PowerManagmentWakeup14,
        PowerManagmentWakeup15,
        PowerManagmentWakeup16,
        PowerManagmentWakeup17,
        PowerManagmentWakeup20,
        PowerManagmentWakeup21,
        PowerManagmentWakeup22,
        PowerManagmentWakeup23,
        PowerManagmentWakeup24,
        PowerManagmentWakeup25,
        PowerManagmentWakeup26,
        PowerManagmentWakeup27,
        PowerManagmentWakeup30,
        PowerManagmentWakeup31,
        PowerManagmentWakeup32,
        PowerManagmentWakeup33,
        PowerManagmentWakeup34,
        PowerManagmentWakeup35,
        PowerManagmentWakeup36,
        PowerManagmentWakeup37,
        PowerManagmentWakeup40,
        PowerManagmentWakeup41,
        PowerManagmentWakeup42,
        PowerManagmentWakeup43,
        PowerManagmentWakeup44,
        PowerManagmentWakeup45,
        PowerManagmentWakeup46,
        PowerManagmentWakeup47,
        PowerManagmentWakeup50,
        PowerManagmentWakeup51,
        PowerManagmentWakeup52,
        PowerManagmentWakeup53,
        PowerManagmentWakeup54,
        PowerManagmentWakeup55,
        PowerManagmentWakeup56,
        PowerManagmentWakeup57,
        PowerManagmentWakeup60,
        PowerManagmentWakeup61,
        PowerManagmentWakeup62,
        PowerManagmentWakeup63,
        PowerManagmentWakeup64,
        PowerManagmentWakeup65,
        PowerManagmentWakeup66,
        PowerManagmentWakeup67,
        PowerManagmentWakeup70,
        PowerManagmentWakeup71,
        PowerManagmentWakeup72,
        PowerManagmentWakeup73,
        PowerManagmentWakeup74,
        PowerManagmentWakeup75,
        PowerManagmentWakeup76,
        PowerManagmentWakeup77,
        WakeupFrameMask0,
        WakeupFrameMask1,
        WakeupFrameMask2,
        WakeupFrameMask3,
        WakeupFrameMask4,
        WakeupFrameMask5,
        WakeupFrameMask6,
        WakeupFrameMask7,
        Flash0,
        Flash1,
        Flash2,
        Flash3,
        Configuration5,
        TransmitPriorityPolling,
        Reserved9,
        Reserved10,
        Reserved11,
        Reserved12,
        Reserved13,
        Reserved14,
        CppCommand0,
        CppCommand1,
        Reserved15,
        Reserved16,
        RecieveDescriptorAdress0,
        RecieveDescriptorAdress1,
        RecieveDescriptorAdress2,
        RecieveDescriptorAdress3,
        RecieveDescriptorAdress4,
        RecieveDescriptorAdress5,
        RecieveDescriptorAdress6,
        RecieveDescriptorAdress7,
        CppEarlyTransmitThreshold,
        Reserved17,
        Reserved18,
        Reserved19,
        FunctionEvent0,
        FunctionEvent1,
        FunctionEvent2,
        FunctionEvent3,
        FunctionEventMask0,
        FunctionEventMask1,
        FunctionEventMask2,
        FunctionEventMask3,
        FunctionPresentState0,
        FunctionPresentState1,
        FunctionPresentState2,
        FunctionPresentState3,
        FunctionForceEvent0,
        FunctionForceEvent1,
        FunctionForceEvent2,
        FunctionForceEvent3,
    };
    RTL8139(PCIHeader* header);
    ~RTL8139(void);
    virtual void OnInterrupt(uintptr_t interrupt, Registers* regs, uintptr_t error) override;

    private:
    template <typename T>
    T Read(IOOffset offset) const {
        return *(const T*)(base + (uint8_t)offset);
    }
    template <typename T>
    void Write(IOOffset offset, const T& value) {
        *(T*)(base + (uint8_t)offset) = value;
    }

    /// @brief 8K + 16 + 1500 bytes recieve buffer
    uint32_t rxBuffer[2427];
    MathLib::MAC mac;
    uintptr_t base;
    IRQ irq;
};

#endif
#endif